<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>oscl_singleton.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>oscl_singleton.h</h1><a href="oscl__singleton_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// -*- c++ -*-</span>
00002 <span class="comment">// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =</span>
00003 
00004 <span class="comment">//                     O S C L _ S I N G L E T O N</span>
00005 
00006 <span class="comment">// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =</span>
00007 
00020 <span class="preprocessor">#ifndef OSCL_SINGLETON_H_INCLUDED</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define OSCL_SINGLETON_H_INCLUDED</span>
00022 <span class="preprocessor"></span>
00023 <span class="preprocessor">#ifndef OSCL_BASE_H_INCLUDED</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="oscl__base_8h.html">oscl_base.h</a>"</span>
00025 <span class="preprocessor">#endif</span>
00026 <span class="preprocessor"></span>
00027 <span class="preprocessor">#ifndef OSCL_DEFALLOC_H_INCLUDED</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="oscl__defalloc_8h.html">oscl_defalloc.h</a>"</span>
00029 <span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span>
00031 
00032 <span class="preprocessor">#if (OSCL_HAS_SINGLETON_SUPPORT)</span>
00033 <span class="preprocessor"></span>
00034 <span class="comment">//verify config-- singleton support requires global var support</span>
00035 
00036 <span class="comment">// list of singleton objects</span>
<a name="l00037"></a><a class="code" href="oscl__singleton_8h.html#a0">00037</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a0">OSCL_SINGLETON_ID_TEST</a>           =  0;
<a name="l00038"></a><a class="code" href="oscl__singleton_8h.html#a1">00038</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a1">OSCL_SINGLETON_ID_OSCLMEM</a>        =  1;
<a name="l00039"></a><a class="code" href="oscl__singleton_8h.html#a2">00039</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a2">OSCL_SINGLETON_ID_PVLOGGER</a>       =  2;
<a name="l00040"></a><a class="code" href="oscl__singleton_8h.html#a3">00040</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a3">OSCL_SINGLETON_ID_PVSCHEDULER</a>    =  3;
<a name="l00041"></a><a class="code" href="oscl__singleton_8h.html#a4">00041</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a4">OSCL_SINGLETON_ID_PVERRORTRAP</a>    =  4;
<a name="l00042"></a><a class="code" href="oscl__singleton_8h.html#a5">00042</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a5">OSCL_SINGLETON_ID_SDPMEDIAPARSER</a> =  5;
<a name="l00043"></a><a class="code" href="oscl__singleton_8h.html#a6">00043</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a6">OSCL_SINGLETON_ID_PAYLOADPARSER</a>  =  6;
<a name="l00044"></a><a class="code" href="oscl__singleton_8h.html#a7">00044</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a7">OSCL_SINGLETON_ID_CPM_PLUGIN</a>     =  7;
<a name="l00045"></a><a class="code" href="oscl__singleton_8h.html#a8">00045</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a8">OSCL_SINGLETON_ID_PVMFRECOGNIZER</a> =  8;
<a name="l00046"></a><a class="code" href="oscl__singleton_8h.html#a9">00046</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a9">OSCL_SINGLETON_ID_OSCLREGISTRY</a>   =  9;
<a name="l00047"></a><a class="code" href="oscl__singleton_8h.html#a10">00047</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a10">OSCL_SINGLETON_ID_OMX</a>            = 10;
<a name="l00048"></a><a class="code" href="oscl__singleton_8h.html#a11">00048</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a11">OSCL_SINGLETON_ID_OMXMASTERCORE</a>  = 11;
<a name="l00049"></a><a class="code" href="oscl__singleton_8h.html#a12">00049</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a12">OSCL_SINGLETON_ID_TICKCOUNT</a>      = 12;
<a name="l00050"></a><a class="code" href="oscl__singleton_8h.html#a13">00050</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a13">OSCL_SINGLETON_ID_WMDRMLOCK</a>      = 13;
<a name="l00051"></a><a class="code" href="oscl__singleton_8h.html#a14">00051</a> <span class="keyword">const</span> uint32 <a class="code" href="oscl__singleton_8h.html#a14">OSCL_SINGLETON_ID_LAST</a>           = 14;
00052 
00053 
<a name="l00054"></a><a class="code" href="classOsclSingletonRegistry.html">00054</a> <span class="keyword">class </span><a class="code" href="classOsclSingletonRegistry.html">OsclSingletonRegistry</a>
00055 {
00056     <span class="keyword">public</span>:
00057         <span class="comment">/*</span>
00058 <span class="comment">        ** Get an entry</span>
00059 <span class="comment">        ** @param ID: identifier</span>
00060 <span class="comment">        ** @param error (output) 0 for success or an error from TPVBaseErrorEnum</span>
00061 <span class="comment">        ** @returns: the entry value</span>
00062 <span class="comment">        */</span>
00063         <a class="code" href="osclconfig_8h.html#a3">OSCL_IMPORT_REF</a> <span class="keyword">static</span> <a class="code" href="group__osclbase.html#a27">OsclAny</a>* <a class="code" href="classOsclSingletonRegistry.html#d0">getInstance</a>(uint32 ID, int32 &amp;error);
00064         <span class="comment">/*</span>
00065 <span class="comment">        ** Set an entry</span>
00066 <span class="comment">        ** @param ID: identifier</span>
00067 <span class="comment">        ** @param error (output) 0 for success or an error from TPVBaseErrorEnum</span>
00068 <span class="comment">        ** @returns: the entry value</span>
00069 <span class="comment">        */</span>
00070         <a class="code" href="osclconfig_8h.html#a3">OSCL_IMPORT_REF</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classOsclSingletonRegistry.html#d1">registerInstance</a>(<a class="code" href="group__osclbase.html#a27">OsclAny</a>* ptr, uint32 ID, int32 &amp;error);
00071 
00072         <span class="comment">/*</span>
00073 <span class="comment">        //These two APIs can be used to do "test and set" operations on a singleton.</span>
00074 <span class="comment">        //Be sure to always call both APIs to avoid deadlock.</span>
00075 <span class="comment">        */</span>
00076 
00077         <span class="comment">/*</span>
00078 <span class="comment">        * Return the current value of the singleton and leave the singleton table locked</span>
00079 <span class="comment">        * on return.</span>
00080 <span class="comment">        * @param ID the singleton ID</span>
00081 <span class="comment">        ** @param error (output) 0 for success or an error from TPVBaseErrorEnum</span>
00082 <span class="comment">        * @returns the singleton value.</span>
00083 <span class="comment">        */</span>
00084         <a class="code" href="osclconfig_8h.html#a3">OSCL_IMPORT_REF</a> <span class="keyword">static</span> <a class="code" href="group__osclbase.html#a27">OsclAny</a>* <a class="code" href="classOsclSingletonRegistry.html#d2">lockAndGetInstance</a>(uint32 ID, int32&amp; error);
00085         <span class="comment">/*</span>
00086 <span class="comment">        * Set the value of the singleton.  Assume the singleton table is locked on entry.</span>
00087 <span class="comment">        * @param ptr the singleton value</span>
00088 <span class="comment">        * @param ID the singleton ID</span>
00089 <span class="comment">        ** @param error (output) 0 for success or an error from TPVBaseErrorEnum</span>
00090 <span class="comment">        */</span>
00091         <a class="code" href="osclconfig_8h.html#a3">OSCL_IMPORT_REF</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classOsclSingletonRegistry.html#d3">registerInstanceAndUnlock</a>(<a class="code" href="group__osclbase.html#a27">OsclAny</a>* ptr, uint32 ID, int32&amp; error);
00092 
00093     <span class="keyword">private</span>:
00094         <a class="code" href="classOsclSingletonRegistry.html">OsclSingletonRegistry</a>()
00095         {}
00096         <span class="keyword">typedef</span> <a class="code" href="group__osclbase.html#a27">OsclAny</a>* registry_type;
00097         <span class="keyword">typedef</span> registry_type* registry_pointer_type;
00098 
00099     <span class="keyword">private</span>:
00100         <a class="code" href="osclconfig_8h.html#a3">OSCL_IMPORT_REF</a> <span class="keyword">static</span> <span class="keywordtype">void</span> initialize(<a class="code" href="classOscl__DefAlloc.html">Oscl_DefAlloc</a> &amp;alloc, int32 &amp;error);
00101         <a class="code" href="osclconfig_8h.html#a3">OSCL_IMPORT_REF</a> <span class="keyword">static</span> <span class="keywordtype">void</span> cleanup(<a class="code" href="classOscl__DefAlloc.html">Oscl_DefAlloc</a> &amp;alloc, int32 &amp;error);
<a name="l00102"></a><a class="code" href="classOsclSingletonRegistry.html#l0">00102</a>         <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classOsclSingletonRegistry.html#l0">OsclBase</a>;
00103 
00104     <span class="keyword">private</span>:
00105         <span class="keyword">class </span>SingletonTable
00106         {
00107             <span class="keyword">public</span>:
00108                 SingletonTable(): iRefCount(0)
00109                 {
00110                     <span class="keywordflow">for</span> (uint32 i = 0; i &lt; <a class="code" href="oscl__singleton_8h.html#a14">OSCL_SINGLETON_ID_LAST</a>; i++)
00111                         iSingletons[i] = <a class="code" href="group__osclbase.html#a88">NULL</a>;
00112                 }
00113                 _OsclBasicLock iTableLock;
00114                 uint32 iRefCount;
00115                 <a class="code" href="group__osclbase.html#a27">OsclAny</a>* iSingletons[<a class="code" href="oscl__singleton_8h.html#a14">OSCL_SINGLETON_ID_LAST</a>];
00116                 _OsclBasicLock iSingletonLocks[<a class="code" href="oscl__singleton_8h.html#a14">OSCL_SINGLETON_ID_LAST</a>];
00117         };
00118         <span class="comment">//The singleton table is a global variable.</span>
00119         <span class="keyword">static</span> SingletonTable* iSingletonTable;
00120 };
<a name="l00121"></a><a class="code" href="classOsclSingleton.html">00121</a> 
00122 <span class="keyword">template</span> &lt; <span class="keyword">class</span> T, u<span class="keywordtype">int</span>32 ID, <span class="keyword">class</span> Registry = OsclSingletonRegistry &gt; <span class="keyword">class </span><a class="code" href="classOsclSingleton.html">OsclSingleton</a>
00123 {
00124     <span class="keyword">private</span>:
00125         <span class="comment">// make the copy constructor and assignment operator private</span>
00126         <a class="code" href="classOsclSingleton.html">OsclSingleton</a>&amp; operator=(<a class="code" href="classOsclSingleton.html">OsclSingleton</a>&amp; _Y)
00127         {
00128             <span class="keywordflow">return</span>(*this);
00129         }
00130 
<a name="l00131"></a><a class="code" href="classOsclSingleton.html#n0">00131</a>     <span class="keyword">protected</span>:
00132         T* <a class="code" href="classOsclSingleton.html#n0">_Ptr</a>;
00133 
<a name="l00134"></a><a class="code" href="classOsclSingleton.html#a0">00134</a>     <span class="keyword">public</span>:
00135         <a class="code" href="classOsclSingleton.html#a0">OsclSingleton</a>()
00136         {
00137             int32 err;
00138             <a class="code" href="classOsclSingleton.html#n0">_Ptr</a> = <a class="code" href="group__osclbase.html#a93">OSCL_STATIC_CAST</a>(T*, Registry::getInstance(ID, err));
00139         }
<a name="l00140"></a><a class="code" href="classOsclSingleton.html#a1">00140</a> 
00141         <a class="code" href="classOsclSingleton.html#a1">~OsclSingleton</a>() {};
00142 
00150         T&amp; <a class="code" href="classOsclSingleton.html#a2">operator*</a>()<span class="keyword"> const</span>
00151 <span class="keyword">        </span>{
00152             <span class="keywordflow">return</span>(*_Ptr);
00153         }
00154 
00162         T *<a class="code" href="classOsclSingleton.html#a3">operator-&gt;</a>()<span class="keyword"> const</span>
00163 <span class="keyword">        </span>{
00164             <span class="keywordflow">return</span>(_Ptr);
00165         }
00166 
00167 
00174         <span class="keywordtype">bool</span> <a class="code" href="classOsclSingleton.html#a4">set</a>()
00175         {
00176             int32 err;
00177             <a class="code" href="classOsclSingleton.html#n0">_Ptr</a> = <a class="code" href="group__osclbase.html#a93">OSCL_STATIC_CAST</a>(T*, Registry::getInstance(ID, err));
00178             <span class="keywordflow">return</span> (<a class="code" href="classOsclSingleton.html#n0">_Ptr</a> ? <span class="keyword">true</span> : <span class="keyword">false</span>);
00179         }
00180 
00181 };
00182 
00183 
00184 <span class="preprocessor">#endif //OSCL_HAS_SINGLETON_SUPPORT</span>
00185 <span class="preprocessor"></span>
00186 <span class="preprocessor">#endif</span>
00187 <span class="preprocessor"></span>
</pre></div><hr size="1"><img src="pvlogo_small.jpg"><address style="align: right;"><small>OSCL API</small>
<address style="align: left;"><small>Posting Version: CORE_8.505.1.1 </small>
</small></address>
</body>
</html>
